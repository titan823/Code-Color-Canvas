
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Color Canvas - ライブWebエディタ</title>

    <!-- CodeMirror（CDN） -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>

    <style>
        /* 全体 */
        :root {
            --bg: #1e1e1e;
            --panel: #252526;
            --panel-2: #2d2d2d;
            --panel-3: #333;
            --border-1: #444;
            --accent: #007acc;
            --text: #d4d4d4;
            --muted: #aaaaaa;
            --ok: #7bd88f;
            --ng: #f26d6d;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: var(--panel-3);
            padding: 10px 20px;
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 2px solid var(--accent);
        }

        /* 上位タブ（編集 / プレビュー） */
        .main-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }
        .top-tabs {
            display: flex;
            background-color: var(--bg);
            border-bottom: 2px solid var(--border-1);
        }
        .top-tab-button {
            padding: 10px 16px;
            border: none;
            background-color: var(--panel-2);
            color: #ccc;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .top-tab-button + .top-tab-button {
            border-left: 1px solid var(--border-1);
        }
        .top-tab-button.active {
            background-color: var(--panel-3);
            color: white;
            border-bottom: 3px solid var(--accent);
        }

        .page-container {
            position: relative;
            flex: 1;
            min-height: 0;
        }
        .tab-page {
            position: absolute;
            inset: 0;
            display: none;
        }
        .tab-page.active {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* パネル共通 */
        .panel-header {
            background-color: var(--panel-3);
            padding: 8px 12px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-1);
        }
        .panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }

        /* コードエディタ */
        .code-tabs {
            display: flex;
            background-color: var(--bg);
            border-bottom: 1px solid var(--border-1);
        }
        .tab-button {
            padding: 10px 15px;
            border: none;
            background-color: var(--panel-2);
            color: #ccc;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            background-color: var(--panel-3);
            color: white;
            border-bottom: 3px solid var(--accent);
        }
        .editor-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }
        .CodeMirror {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100% !important;
            font-size: 14px;
        }
        .editor-wrapper {
            display: none;
            height: 100%;
        }
        .editor-wrapper.active {
            display: block;
        }

        /* プレビュー・変更（左右分割） */
        .split-container {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        .split-left, .split-right {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .split-left {
            flex: 1 1 55%;
            border-right: 2px solid var(--border-1);
            min-width: 320px;
        }
        .split-right {
            flex: 1 1 45%;
            min-width: 320px;
        }
        .frame-wrap {
            flex: 1;
            min-height: 0;
        }
        #preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #fff;
        }

        /* インスペクター */
        .inspector-body {
            flex: 1;
            background-color: var(--panel);
            padding: 15px;
            overflow-y: auto;
        }
        .inspector-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .inspector-item label {
            min-width: 120px;
            font-size: 0.9em;
            color: var(--muted);
        }
        .inspector-item input[type="text"],
        .inspector-item textarea {
            background-color: #3c3c3c;
            border: 1px solid #555;
            color: #f0f0f0;
            padding: 6px 8px;
            border-radius: 3px;
            flex: 1 1 240px;
        }
        .inspector-item textarea {
            min-height: 60px;
            resize: vertical;
        }
        .color-swatch {
            width: 18px;
            height: 18px;
            border: 1px solid #555;
            border-radius: 3px;
            background: transparent;
        }
        .validity-badge {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid #555;
            color: #ddd;
        }
        .validity-badge.ok {
            border-color: #2e7d32;
            color: var(--ok);
        }
        .validity-badge.ng {
            border-color: #8e2a2a;
            color: #f26d6d;
        }
        .inspector-actions {
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }
        .btn {
            background: var(--panel-2);
            border: 1px solid #555;
            color: #eee;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover { background: #3a3a3a; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* プレースホルダー */
        #inspector-placeholder {
            color: #aaa;
            margin: 6px 0 0 0;
        }
    </style>
</head>
<body>
    <header>Code Color Canvas</header>

    <main class="main-container">
        <!-- 上位タブ -->
        <div class="top-tabs">
            <button class="top-tab-button active" onclick="showMainTab('code')">コード編集</button>
            <button class="top-tab-button" onclick="showMainTab('preview')">プレビュー・変更</button>
        </div>

        <div class="page-container">
            <!-- コード編集タブ -->
            <section id="code-page" class="tab-page active">
                <div class="panel code-panel">
                    <div class="panel-header">コード編集</div>
                    <div class="code-tabs">
                        <button class="tab-button active" onclick="showEditor('html')">HTML</button>
                        <button class="tab-button" onclick="showEditor('css')">CSS</button>
                        <button class="tab-button" onclick="showEditor('js')">JavaScript</button>
                    </div>
                    <div class="editor-container">
                        <div id="html-editor-wrapper" class="editor-wrapper active">
                            <textarea id="html-code"></textarea>
                        </div>
                        <div id="css-editor-wrapper" class="editor-wrapper">
                            <textarea id="css-code"></textarea>
                        </div>
                        <div id="js-editor-wrapper" class="editor-wrapper">
                            <textarea id="js-code"></textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- プレビュー・変更タブ（左右分割） -->
            <section id="preview-page" class="tab-page">
                <div class="split-container">
                    <div class="split-left">
                        <div class="panel-header">プレビュー</div>
                        <div class="frame-wrap">
                            <iframe id="preview-frame"></iframe>
                        </div>
                    </div>
                    <div class="split-right">
                        <div class="panel-header">インスペクター</div>
                        <div class="inspector-body">
                            <p id="inspector-placeholder">プレビュー内の要素をクリックすると、ここでテキストやスタイルを編集できます。</p>
                            <div id="inspector-ui" style="display: none;">
                                <div class="inspector-item">
                                    <label>選択中の要素</label>
                                    <b id="selected-element-selector"></b>
                                </div>

                                <!-- テキスト編集 -->
                                <div class="inspector-item">
                                    <label for="inspector-text">テキスト</label>
                                    <textarea id="inspector-text" placeholder="選択した要素のテキストを編集"></textarea>
                                    <div class="inspector-actions">
                                        <label style="display:inline-flex; align-items:center; gap:6px; color:#ccc; font-size: 0.9em;">
                                            <input type="checkbox" id="inspector-text-as-html"> HTMLとして編集
                                        </label>
                                        <button class="btn" id="apply-text">適用</button>
                                    </div>
                                </div>

                                <!-- テキスト色 -->
                                <div class="inspector-item">
                                    <label for="inspector-color">テキスト色</label>
                                    <input type="text" id="inspector-color" placeholder="例: #ff8800, rgb(255 136 0 / 80%), hsl(30 100% 50%), rebeccapurple, color(display-p3 1 0.5 0)">
                                    <span class="color-swatch" id="swatch-color"></span>
                                    <span class="validity-badge" id="valid-color">未入力</span>
                                    <div class="inspector-actions">
                                        <button class="btn" id="apply-color" disabled>適用</button>
                                        <button class="btn" id="undo-color" disabled>元に戻す</button>
                                        <button class="btn" id="redo-color" disabled>やり直す</button>
                                    </div>
                                </div>

                                <!-- 背景色 -->
                                <div class="inspector-item">
                                    <label for="inspector-bg">背景色</label>
                                    <input type="text" id="inspector-bg" placeholder="例: transparent, #222, rgba(0 0 0 / .4), lch(50 60 40)">
                                    <span class="color-swatch" id="swatch-bg"></span>
                                    <span class="validity-badge" id="valid-bg">未入力</span>
                                    <div class="inspector-actions">
                                        <button class="btn" id="apply-bg" disabled>適用</button>
                                        <button class="btn" id="undo-bg" disabled>元に戻す</button>
                                        <button class="btn" id="redo-bg" disabled>やり直す</button>
                                    </div>
                                </div>

                                <!-- ボックス系 -->
                                <div class="inspector-item">
                                    <label for="inspector-padding">パディング</label>
                                    <input type="text" id="inspector-padding" placeholder="例: 10px / 8px 12px / 1rem 2rem">
                                </div>
                                <div class="inspector-item">
                                    <label for="inspector-margin">マージン</label>
                                    <input type="text" id="inspector-margin" placeholder="例: 10px auto / 0 16px">
                                </div>
                                <div class="inspector-item">
                                    <label for="inspector-fontSize">フォントサイズ</label>
                                    <input type="text" id="inspector-fontSize" placeholder="例: 16px / 1.2rem / clamp(14px, 2vw, 20px)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- グローバル ---
            let selectedElement = null;
            let lastHighlightedElement = null;
            let lastSelectedSelectorPath = null; // プレビュー更新後の選択復元用

            // 色の履歴（セレクタごと／プロパティごと）: Undo/Redo スタック
            // Map<string, { color: {undo:string[], redo:string[]}, backgroundColor: {undo:string[], redo:string[]} }>
            const colorHistory = new Map();

            function getHistory(selector) {
                if (!colorHistory.has(selector)) {
                    colorHistory.set(selector, {
                        color: { undo: [], redo: [] },
                        backgroundColor: { undo: [], redo: [] }
                    });
                }
                return colorHistory.get(selector);
            }

            // --- CodeMirror 初期化 ---
            const htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-code'), {
                mode: 'xml',
                htmlMode: true,
                theme: 'material-darker',
                lineNumbers: true,
            });
            const cssEditor = CodeMirror.fromTextArea(document.getElementById('css-code'), {
                mode: 'css',
                theme: 'material-darker',
                lineNumbers: true,
            });
            const jsEditor = CodeMirror.fromTextArea(document.getElementById('js-code'), {
                mode: 'javascript',
                theme: 'material-darker',
                lineNumbers: true,
            });

            // --- 初期コード（HTMLは<body>内に入る想定） ---
            const initialHTML = `<div class="container">
  <h1 id="main-title">Code Color Canvasへようこそ！</h1>
  <p>ここにあるテキストやスタイルを自由に編集できます。</p>
  <button id="action-btn">クリック</button>
</div>`;
            const initialCSS = `/* ページ全体のスタイル */
html, body {
  height: 100%;
}
body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  background-color: #f0f0f0;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0;
}

.container {
  text-align: center;
  padding: 40px;
  background-color: white;
  border-radius: 12px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.12);
}

#main-title {
  color: #333;
  margin: 0 0 10px 0;
}

#action-btn {
  background-color: #007acc;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
}`;
            const initialJS = `document.getElementById('action-btn')?.addEventListener('click', (e) => {
  alert('ボタンがクリックされました！');
});`;

            htmlEditor.setValue(initialHTML);
            cssEditor.setValue(initialCSS);
            jsEditor.setValue(initialJS);

            // --- 上位タブの切替 ---
            window.showMainTab = function(name) {
                document.querySelectorAll('.top-tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
                if (name === 'code') {
                    document.querySelector(`.top-tab-button[onclick="showMainTab('code')"]`).classList.add('active');
                    document.getElementById('code-page').classList.add('active');
                    htmlEditor.refresh();
                    cssEditor.refresh();
                    jsEditor.refresh();
                } else {
                    document.querySelector(`.top-tab-button[onclick="showMainTab('preview')"]`).classList.add('active');
                    document.getElementById('preview-page').classList.add('active');
                }
            };

            // --- サブタブ（HTML/CSS/JS） ---
            window.showEditor = function(editorName) {
                document.querySelectorAll('.editor-wrapper').forEach(w => w.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));

                document.getElementById(`${editorName}-editor-wrapper`).classList.add('active');
                document.querySelector(`.tab-button[onclick="showEditor('${editorName}')"]`).classList.add('active');

                if (editorName === 'html') htmlEditor.refresh();
                if (editorName === 'css') cssEditor.refresh();
                if (editorName === 'js') jsEditor.refresh();
            };

            // --- プレビュー更新 ---
            function updatePreview() {
                const iframe = document.getElementById('preview-frame');
                const doc = iframe.contentDocument || iframe.contentWindow.document;

                const htmlCode = htmlEditor.getValue();
                const cssCode = cssEditor.getValue();
                const jsCode = jsEditor.getValue();

                doc.open();
                doc.write(`<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>${cssCode}</style>
</head>
<body>
${htmlCode}
<script>(function(){\n${jsCode}\n})();<\/script>
</body>
</html>`);
                doc.close();

                // プレビュー再構築後にイベントを再設定
                setupInspectorListeners();

                // 再選択を試みる（前回クリックしていた要素）
                if (!restoreSelection()) {
                    selectedElement = null;
                    lastHighlightedElement = null;
                    showInspectorPlaceholder();
                }
            }

            htmlEditor.on('change', updatePreview);
            cssEditor.on('change', updatePreview);
            jsEditor.on('change', updatePreview);

            // --- インスペクター関連 ---
            function setupInspectorListeners() {
                const iframe = document.getElementById('preview-frame');
                const pdoc = iframe.contentDocument || iframe.contentWindow.document;
                const pbody = pdoc && pdoc.body;
                if (!pbody) return;

                pbody.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    if (lastHighlightedElement) lastHighlightedElement.style.outline = '';

                    selectedElement = e.target;
                    selectedElement.style.outline = '2px solid #007acc';
                    lastHighlightedElement = selectedElement;

                    lastSelectedSelectorPath = getCssSelector(selectedElement);
                    populateInspector(selectedElement);
                }, { capture: true });
            }

            function restoreSelection() {
                if (!lastSelectedSelectorPath) return false;
                const iframe = document.getElementById('preview-frame');
                const pdoc = iframe.contentDocument || iframe.contentWindow.document;
                if (!pdoc) return false;
                let el = null;
                try { el = pdoc.querySelector(lastSelectedSelectorPath); } catch (_) {}
                if (el) {
                    if (lastHighlightedElement) lastHighlightedElement.style.outline = '';
                    selectedElement = el;
                    selectedElement.style.outline = '2px solid #007acc';
                    lastHighlightedElement = selectedElement;
                    populateInspector(selectedElement);
                    return true;
                }
                return false;
            }

            function getCssSelector(el) {
                if (!el || el.nodeType !== 1) return '';
                const parts = [];
                while (el && el.nodeType === 1) {
                    let selector = el.nodeName.toLowerCase();
                    if (el.id) {
                        selector = '#' + el.id;
                        parts.unshift(selector);
                        break;
                    } else {
                        if (el.classList && el.classList.length) {
                            selector += '.' + el.classList[0];
                        }
                        let sib = el, nth = 1;
                        while (sib = sib.previousElementSibling) {
                            if (sib.nodeName.toLowerCase() === el.nodeName.toLowerCase()) nth++;
                        }
                        if (nth !== 1) selector += `:nth-of-type(${nth})`;
                    }
                    parts.unshift(selector);
                    el = el.parentNode;
                }
                return parts.join(' > ');
            }

            function showInspectorPlaceholder() {
                document.getElementById('inspector-placeholder').style.display = 'block';
                document.getElementById('inspector-ui').style.display = 'none';
            }

            function populateInspector(element) {
                document.getElementById('inspector-placeholder').style.display = 'none';
                document.getElementById('inspector-ui').style.display = 'block';

                const iframe = document.getElementById('preview-frame');
                const pwin = iframe.contentWindow;
                const styles = pwin.getComputedStyle(element);

                document.getElementById('selected-element-selector').textContent = getCssSelector(element);

                // テキスト初期表示（デフォルトはtextContent）
                const textAsHTML = document.getElementById('inspector-text-as-html');
                textAsHTML.checked = false;
                document.getElementById('inspector-text').value = element.textContent ?? '';

                // カラー表示
                const colorInput = document.getElementById('inspector-color');
                const bgInput = document.getElementById('inspector-bg');
                colorInput.value = styles.color || '';
                bgInput.value = styles.backgroundColor || '';

                updateColorUI('color');
                updateColorUI('bg');
                updateApplyButtons();
                updateHistoryButtons();

                // ボックス系
                document.getElementById('inspector-padding').value = styles.padding || '';
                document.getElementById('inspector-margin').value = styles.margin || '';
                document.getElementById('inspector-fontSize').value = styles.fontSize || '';
            }

            // CSSコードへの反映（選択要素への即時反映＋CSSエディタ更新）
            function applyStyleChange(property, value) {
                if (!selectedElement) return;

                // 即時反映（プレビュー内の要素）
                selectedElement.style[property] = value;

                // CSSエディタへ反映
                const selector = getCssSelector(selectedElement);
                let cssCode = cssEditor.getValue();

                // camelCase -> kebab-case
                const cssProperty = property.replace(/([A-Z])/g, '-$1').toLowerCase();

                // セレクタルールを探す
                const esc = selector.replace(/[\/\\^$*+?.()|[\]{}]/g, '\\$&');
                const regex = new RegExp(`(${esc})\\s*\\{([^}]*)\\}`, 's');
                const match = cssCode.match(regex);

                if (match) {
                    let properties = match[2];
                    const propRegex = new RegExp(`(^|;)\\s*${cssProperty}\\s*:[^;]*`, 'i');
                    if (propRegex.test(properties)) {
                        const newProperties = properties.replace(propRegex, `$1 ${cssProperty}: ${value}`);
                        cssCode = cssCode.replace(match[0], `${selector} {${newProperties}}`);
                    } else {
                        const trimmed = properties.trim();
                        const sep = trimmed && !trimmed.endsWith(';') ? ';' : '';
                        const newProperties = `${trimmed}${sep} ${cssProperty}: ${value}; `;
                        cssCode = cssCode.replace(match[0], `${selector} {\n${newProperties}\n}`);
                    }
                } else {
                    cssCode += `\n\n${selector} {\n    ${cssProperty}: ${value};\n}`;
                }

                // 選択を維持するためにセレクタを保存
                lastSelectedSelectorPath = selector;
                cssEditor.setValue(cssCode);
            }

            // --- カラー入力（全CSS色表記対応） ---
            function isValidCSSColor(value) {
                const iframe = document.getElementById('preview-frame');
                const pwin = iframe.contentWindow;
                try {
                    if (pwin.CSS && typeof pwin.CSS.supports === 'function') {
                        return pwin.CSS.supports('color', value);
                    }
                } catch (_) {}
                // フォールバック
                const opt = pwin.document.createElement('option');
                opt.style.color = '';
                opt.style.color = value;
                return !!opt.style.color;
            }

            function updateColorUI(kind) {
                const input = document.getElementById(kind === 'color' ? 'inspector-color' : 'inspector-bg');
                const swatch = document.getElementById(kind === 'color' ? 'swatch-color' : 'swatch-bg');
                const badge = document.getElementById(kind === 'color' ? 'valid-color' : 'valid-bg');
                const val = input.value.trim();

                if (!val) {
                    swatch.style.background = 'transparent';
                    badge.textContent = '未入力';
                    badge.classList.remove('ok','ng');
                } else if (isValidCSSColor(val)) {
                    swatch.style.background = val;
                    badge.textContent = 'OK';
                    badge.classList.add('ok');
                    badge.classList.remove('ng');
                } else {
                    swatch.style.background = 'transparent';
                    badge.textContent = '不正';
                    badge.classList.add('ng');
                    badge.classList.remove('ok');
                }
                updateApplyButtons();
            }

            function updateApplyButtons() {
                const colorVal = document.getElementById('inspector-color').value.trim();
                const bgVal = document.getElementById('inspector-bg').value.trim();
                document.getElementById('apply-color').disabled = !(selectedElement && isValidCSSColor(colorVal));
                document.getElementById('apply-bg').disabled = !(selectedElement && isValidCSSColor(bgVal));
            }

            function updateHistoryButtons() {
                const selector = lastSelectedSelectorPath;
                const entry = selector ? colorHistory.get(selector) : null;

                const canUndoColor = !!(entry && entry.color.undo.length);
                const canUndoBg = !!(entry && entry.backgroundColor.undo.length);
                const canRedoColor = !!(entry && entry.color.redo.length);
                const canRedoBg = !!(entry && entry.backgroundColor.redo.length);

                document.getElementById('undo-color').disabled = !canUndoColor;
                document.getElementById('undo-bg').disabled = !canUndoBg;
                document.getElementById('redo-color').disabled = !canRedoColor;
                document.getElementById('redo-bg').disabled = !canRedoBg;
            }

            // 入力イベント: カラー（UI更新のみ。適用はボタンで）
            document.getElementById('inspector-color').addEventListener('input', () => updateColorUI('color'));
            document.getElementById('inspector-bg').addEventListener('input', () => updateColorUI('bg'));

            // 適用ボタン: テキスト色 / 背景色
            document.getElementById('apply-color').addEventListener('click', () => commitColor('color'));
            document.getElementById('apply-bg').addEventListener('click', () => commitColor('backgroundColor'));

            // 元に戻す / やり直す
            document.getElementById('undo-color').addEventListener('click', () => undoColor('color'));
            document.getElementById('undo-bg').addEventListener('click', () => undoColor('backgroundColor'));
            document.getElementById('redo-color').addEventListener('click', () => redoColor('color'));
            document.getElementById('redo-bg').addEventListener('click', () => redoColor('backgroundColor'));

            function commitColor(prop) {
                if (!selectedElement) return;
                const input = document.getElementById(prop === 'color' ? 'inspector-color' : 'inspector-bg');
                const val = input.value.trim();
                if (!isValidCSSColor(val)) return;

                const selector = getCssSelector(selectedElement);
                lastSelectedSelectorPath = selector;

                const iframe = document.getElementById('preview-frame');
                const pwin = iframe.contentWindow;
                const styles = pwin.getComputedStyle(selectedElement);
                const prev = prop === 'color' ? styles.color : styles.backgroundColor;

                // 履歴に積む（Undo）、Redoはクリア（新規分岐）
                const h = getHistory(selector);
                h[prop].undo.push(prev);
                h[prop].redo.length = 0;

                updateHistoryButtons();

                // 実際に反映（CSSソースも更新）
                applyStyleChange(prop, val);
            }

            function undoColor(prop) {
                const selector = lastSelectedSelectorPath;
                if (!selector) return;
                const h = colorHistory.get(selector);
                if (!h || !h[prop] || !h[prop].undo.length) return;

                // 現在値をRedoスタックに積む
                const iframe = document.getElementById('preview-frame');
                const pwin = iframe.contentWindow;
                const styles = pwin.getComputedStyle(selectedElement);
                const currentVal = prop === 'color' ? styles.color : styles.backgroundColor;
                h[prop].redo.push(currentVal);

                // 直前の値を取り出して適用
                const prev = h[prop].undo.pop();

                // 入力欄も更新
                const input = document.getElementById(prop === 'color' ? 'inspector-color' : 'inspector-bg');
                input.value = prev || '';
                updateColorUI(prop === 'color' ? 'color' : 'bg');

                applyStyleChange(prop, prev);
                updateHistoryButtons();
            }

            function redoColor(prop) {
                const selector = lastSelectedSelectorPath;
                if (!selector) return;
                const h = colorHistory.get(selector);
                if (!h || !h[prop] || !h[prop].redo.length) return;

                // 現在値をUndoスタックに積む
                const iframe = document.getElementById('preview-frame');
                const pwin = iframe.contentWindow;
                const styles = pwin.getComputedStyle(selectedElement);
                const currentVal = prop === 'color' ? styles.color : styles.backgroundColor;
                h[prop].undo.push(currentVal);

                // Redoスタックから取り出して適用
                const nextVal = h[prop].redo.pop();

                // 入力欄も更新
                const input = document.getElementById(prop === 'color' ? 'inspector-color' : 'inspector-bg');
                input.value = nextVal || '';
                updateColorUI(prop === 'color' ? 'color' : 'bg');

                applyStyleChange(prop, nextVal);
                updateHistoryButtons();
            }

            // テキスト編集
            const textArea = document.getElementById('inspector-text');
            const textAsHTML = document.getElementById('inspector-text-as-html');
            const applyTextBtn = document.getElementById('apply-text');

            // 表示モード切り替え時（textContent / innerHTML）に値を入れ替え
            textAsHTML.addEventListener('change', () => {
                if (!selectedElement) return;
                textArea.value = textAsHTML.checked ? (selectedElement.innerHTML ?? '') : (selectedElement.textContent ?? '');
            });

            // HTMLソース内の要素を見つけやすくするためのセレクタ補正（body相対に寄せる）
            function toBodyRelativeSelector(sel) {
                return sel
                    .replace(/^html\s*>\s*body\s*>\s*/i, '')
                    .replace(/^body\s*>\s*/i, '');
            }

            // テキスト適用（HTMLエディタのソースにも反映）
            applyTextBtn.addEventListener('click', () => {
                if (!selectedElement) return;
                const selector = getCssSelector(selectedElement);
                lastSelectedSelectorPath = selector;

                const value = textArea.value ?? '';

                // プレビューに即時反映
                if (textAsHTML.checked) {
                    selectedElement.innerHTML = value;
                } else {
                    selectedElement.textContent = value;
                }

                // HTMLソースを更新（DOMとして編集してからエディタへ反映）
                const wrapper = document.createElement('div');
                wrapper.innerHTML = htmlEditor.getValue();

                let target = null;
                try { target = wrapper.querySelector(selector); } catch (_) {}
                if (!target) {
                    const rel = toBodyRelativeSelector(selector);
                    try { target = wrapper.querySelector(rel); } catch (_) {}
                }
                if (!target && selectedElement.id) {
                    try { target = wrapper.querySelector('#' + selectedElement.id); } catch (_) {}
                }

                if (target) {
                    if (textAsHTML.checked) {
                        target.innerHTML = value;
                    } else {
                        target.textContent = value;
                    }
                    htmlEditor.setValue(wrapper.innerHTML.trim());
                }
            });

            // 入力イベント: ボックス系（変更確定時に反映）
            document.getElementById('inspector-padding').addEventListener('change', (e) => {
                const value = e.target.value.trim();
                if (value) {
                    lastSelectedSelectorPath = selectedElement ? getCssSelector(selectedElement) : lastSelectedSelectorPath;
                    applyStyleChange('padding', value);
                }
            });
            document.getElementById('inspector-margin').addEventListener('change', (e) => {
                const value = e.target.value.trim();
                if (value) {
                    lastSelectedSelectorPath = selectedElement ? getCssSelector(selectedElement) : lastSelectedSelectorPath;
                    applyStyleChange('margin', value);
                }
            });
            document.getElementById('inspector-fontSize').addEventListener('change', (e) => {
                const value = e.target.value.trim();
                if (value) {
                    lastSelectedSelectorPath = selectedElement ? getCssSelector(selectedElement) : lastSelectedSelectorPath;
                    applyStyleChange('fontSize', value);
                }
            });

            // --- 初期プレビュー描画 ---
            updatePreview();

            // 最初はコードタブ表示
            showMainTab('code');
        });
    </script>
</body>
</html>
